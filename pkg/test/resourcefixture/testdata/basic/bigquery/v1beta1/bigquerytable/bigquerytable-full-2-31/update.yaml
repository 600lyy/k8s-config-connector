# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: bigquery.cnrm.cloud.google.com/v1beta1
kind: BigQueryTable
metadata:
  name: bigquerytable-${uniqueId}
  labels:
    label-one: "value-one-updated" # MODIFIED
spec:
  friendlyName: BigQuery Table Updated # MODIFIED
  description: "A BigQuery Table with an external data configuration and schema - updated" # MODIFIED
  datasetRef:
    name: bigquerydataset-${uniqueId}
  resourceID: bigquerytable-${uniqueId}
  clustering: # MODIFIED
    - "column1" # clustering order can be changed, and columns can be added/removed
    - "column3"
  timePartitioning:
    type: DAY
    expirationMs: 3592000000 # MODIFIED - 30 days updated to 41.57 days
    field: dateField
  rangePartitioning:
    field: intField
    range:
      start: 0
      end: 2000 # MODIFIED
      interval: 200 # MODIFIED
  requirePartitionFilter: false # MODIFIED
  expirationTime: 1738689600000 # MODIFIED - Jan 1 2025 updated to Feb 1 2025
  schema: '[{"name":"name","type":"STRING","mode":"NULLABLE"},{"name":"post_abbr","type":"STRING","mode":"NULLABLE"},{"name":"new_column","type":"INTEGER","mode":"NULLABLE"}]' # MODIFIED - schema updated
  externalDataConfiguration:
    autodetect: false # MODIFIED
    sourceUris: # MODIFIED
      - "gs://test-bucket-${uniqueId}/external-data-updated.csv"
    sourceFormat: CSV
    compression: NONE # MODIFIED
    ignoreUnknownValues: false # MODIFIED
    maxBadRecords: 20 # MODIFIED
    csvOptions:
      quote: "'" # MODIFIED
      allowJaggedRows: false # MODIFIED
      allowQuotedNewlines: false # MODIFIED
      encoding: ISO-8859-1 # MODIFIED
      fieldDelimiter: ";" # MODIFIED
      skipLeadingRows: 2 # MODIFIED
    hivePartitioningOptions:
      mode: STRINGS # MODIFIED
      sourceUriPrefix: "gs://test-bucket-${uniqueId}/hive_data_updated/" # MODIFIED
      requirePartitionFilter: false # MODIFIED
  encryptionConfiguration:
    kmsKeyRef:
      name: kmskey-${uniqueId} # Assuming this can be updated to a different key, or re-specified. If not, this line should be removed if no change is intended or possible.
  view:
    query: "SELECT name, post_abbr, new_column FROM `project.dataset.basetable`" # MODIFIED
    useLegacySql: true # MODIFIED
  materializedView:
    query: "SELECT vendor, SUM(totals) AS grand_total FROM `project.dataset.orders` GROUP BY vendor" # MODIFIED - vendor instead of 供应商
    enableRefresh: false # MODIFIED
    refreshIntervalMs: 3600000 # MODIFIED - 30 minutes updated to 1 hour
  tableConstraints: # MODIFIED - Constraints are mutable
    primaryKey:
      columns:
        - "name"
        - "post_abbr" # Added another column to PK
    foreignKeys:
      - name: "fk_constraint_name_updated" # MODIFIED
        columnReferences:
          referencingColumn: "post_abbr" # MODIFIED
          referencedColumn: "other_post_abbr" # MODIFIED
        referencedTable:
          projectId: "other-project-${uniqueId}"
          datasetId: "other-dataset-${uniqueId}"
          tableId: "other-table-updated-${uniqueId}" # MODIFIED