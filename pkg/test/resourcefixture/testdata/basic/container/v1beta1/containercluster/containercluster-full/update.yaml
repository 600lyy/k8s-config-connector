# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: container.cnrm.cloud.google.com/v1beta1
kind: ContainerCluster
metadata:
  name: containercluster-${uniqueId}
spec:
  projectRef:
    external: ${projectId}
  location: us-central1
  # description: "A full ContainerCluster - Updated" # Immutable
  # initialNodeCount: 2 # Immutable
  nodeLocations: # Mutable at node pool level, top level is for default pool creation
  - "us-central1-c" # Changed one location
  - "us-central1-b"
  minMasterVersion: "1.21.0" # Updated
  nodeVersion: "1.21.0" # Updated
  # clusterIpv4Cidr: "10.0.0.0/14" # Immutable
  # enableKubernetesAlpha: true # Immutable
  enableLegacyAbac: true # Updated
  enableShieldedNodes: false # Updated
  # enableTpu: true # Immutable
  enableIntranodeVisibility: false # Updated
  enableL4IlbSubsetting: false # Updated
  enableFqdnNetworkPolicy: false # Updated
  # enableMultiNetworking: true # Immutable
  # defaultMaxPodsPerNode: 100 # Immutable
  # datapathProvider: "DATAPATH_PROVIDER_UNSPECIFIED" # Immutable
  privateIpv6GoogleAccess: "PRIVATE_IPV6_GOOGLE_ACCESS_TO_GOOGLE" # Updated
  # networkingMode: "ROUTES" # Immutable
  addonsConfig:
    httpLoadBalancing:
      disabled: true # Updated
    horizontalPodAutoscaling:
      disabled: true # Updated
    networkPolicyConfig:
      disabled: true # Updated (Requires networkPolicy.enabled to be false)
    cloudrunConfig:
      disabled: false # Updated
      loadBalancerType: "LOAD_BALANCER_TYPE_INTERNAL" # Updated
    dnsCacheConfig:
      enabled: false # Updated
    configConnectorConfig:
      enabled: false # Updated
    gcePersistentDiskCsiDriverConfig:
      enabled: false # Updated
    gcpFilestoreCsiDriverConfig:
      enabled: false # Updated
    gcsFuseCsiDriverConfig:
      enabled: false # Updated
    gkeBackupAgentConfig:
      enabled: true # Updated
    istioConfig:
      disabled: false # Updated
      auth: "AUTH_NULL" # Updated
    # kalmConfig: # Not changing, deprecated
    #   enabled: false
  masterAuth:
    # clientCertificateConfig: # issueClientCertificate is immutable
    #   issueClientCertificate: true
    username: "updatedmin" # Updated
    password:
      valueFrom:
        secretKeyRef:
          name: "secret-updated-${uniqueId}" # Updated
          key: "masterAuth.password.updated"
  nodeConfig: # Many fields here are immutable for default node pool after creation
    # machineType: "n1-standard-1" # Immutable
    # diskSizeGb: 50 # Immutable
    # diskType: "pd-ssd" # Immutable
    oauthScopes: # Updated
    - "https://www.googleapis.com/auth/cloud-platform"
    serviceAccountRef: # Updated
      name: "containercluster-updated-sa-${uniqueId}"
    # preemptible: true # Immutable
    # spot: true # Immutable
    imageType: "UBUNTU_CONTAINERD" # Updated
    # minCpuPlatform: "Intel Skylake" # Immutable
    tags: # Updated
    - "new-tag1"
    - "new-tag2"
    # guestAccelerator: [] # Immutable
    # shieldedInstanceConfig: # Immutable at nodeConfig level
    #   enableSecureBoot: false
    #   enableIntegrityMonitoring: false
    kubeletConfig: # Updated
      cpuManagerPolicy: "static"
      cpuCfsQuota: false
      cpuCfsQuotaPeriod: "200us"
      podPidsLimit: 2048
    taint: # Updated
    - key: "key2"
      value: "value2"
      effect: "NO_EXECUTE"
    # workloadMetadataConfig: # mode is immutable
    #   mode: "GCE_METADATA"
    # sandboxConfig: # Immutable
    #   sandboxType: "disabled"
    # reservationAffinity: {} # Immutable
    # localSsdCount: 1 # Immutable
    # ephemeralStorageConfig: # Immutable
    #  localSsdCount: 1
    # localNvmeSsdBlockConfig: # Immutable
    #  localSsdCount: 1
    loggingVariant: "DEFAULT" # Updated from MAX_THROUGHPUT in create's nodePoolDefaults if that was the effective one. Here directly for default pool.
    # gcfsConfig: # Immutable
    #   enabled: false
    # gvnic: # Immutable
    #   enabled: false
    # advancedMachineFeatures: # Immutable
    #   threadsPerCore: 1
    # bootDiskKMSCryptoKeyRef: # Mutable
    #   name: "containercluster-updated-kms-${uniqueId}"
    # confidentialNodes: # Immutable
    #   enabled: true
    # hostMaintenancePolicy: # Immutable
    #   maintenanceInterval: "AS_NEEDED"
    fastSocket: # Updated
      enabled: false
  networkPolicy:
    enabled: false # Updated (to match addonsConfig.networkPolicyConfig.disabled=true)
    provider: "PROVIDER_UNSPECIFIED" # Updated
  masterAuthorizedNetworksConfig: # Updated
    cidrBlocks:
    - displayName: "Updated Office Network"
      cidrBlock: "192.168.2.0/24"
    - displayName: "VPN"
      cidrBlock: "10.10.0.0/16"
    gcpPublicCidrsAccessEnabled: false # Updated
  ipAllocationPolicy:
    # clusterSecondaryRangeName: "pods-updated" # Immutable
    # servicesSecondaryRangeName: "services-updated" # Immutable
    # stackType: "IPV4_IPV6" # Immutable
    additionalPodRangesConfig: # Updated
      podRangeNames: ["new-pod-range-1"]
  privateClusterConfig:
    # enablePrivateNodes: false # Immutable
    enablePrivateEndpoint: true # Updated
    # masterIpv4CidrBlock: "172.16.0.64/28" # Immutable
    masterGlobalAccessConfig: # Updated
      enabled: false
  releaseChannel:
    channel: "STABLE" # Updated
  workloadIdentityConfig:
    workloadPool: "${projectId}.svc.id.updated.goog" # Updated
  databaseEncryption:
    state: "DECRYPTED" # Updated
    # keyName: # Removed as state is DECRYPTED
  verticalPodAutoscaling:
    enabled: false # Updated
  authenticatorGroupsConfig:
    securityGroup: "updated-gke-security-groups@example.com" # Updated
  binaryAuthorization:
    evaluationMode: "DISABLED" # Updated
  clusterAutoscaling:
    enabled: false # Updated (This might make sub-fields irrelevant)
    autoscalingProfile: "OPTIMIZE_UTILIZATION" # Updated
    resourceLimits: # Updated
    - resourceType: "cpu"
      minimum: 2
      maximum: 12
    - resourceType: "memory"
      minimum: 2 #GB
      maximum: 80 #GB
    autoProvisioningDefaults: # Updated
      oauthScopes:
      - "https://www.googleapis.com/auth/devstorage.read_write"
      serviceAccountRef:
        name: "containercluster-nap-updated-${uniqueId}"
      upgradeSettings: # Updated
        maxSurge: 2
        maxUnavailable: 1 # Must be > 0 if maxSurge > 0 for SURGE
        strategy: "SURGE"
        # blueGreenSettings removed as strategy is SURGE
      management: # Not changing autoRepair/autoUpgrade
        autoRepair: true
        autoUpgrade: true
      shieldedInstanceConfig: # Updated
        enableSecureBoot: false
        enableIntegrityMonitoring: false
      diskSize: 60 #GB, Updated
      imageType: "UBUNTU_CONTAINERD" # Updated
      minCpuPlatform: "Intel Broadwell" # Updated
  loggingConfig:
    enableComponents: # Updated
    - "SYSTEM_COMPONENTS"
  monitoringConfig:
    enableComponents: # Updated
    - "SYSTEM_COMPONENTS"
    - "WORKLOADS"
    advancedDatapathObservabilityConfig: # Updated
    - enableMetrics: false
      relayMode: "EXTERNAL_LB"
  notificationConfig:
    pubsub:
      enabled: false # Updated
      # topicRef: # Not providing if disabled
      #   name: "containercluster-updated-${uniqueId}"
      # filter: # Not providing if disabled
      #   eventType:
      #   - "UPGRADE_EVENT"
  # confidentialNodes: # Top level is immutable if set during creation. Default pool's config is via nodeConfig.
  #   enabled: false
  allowNetAdmin: false # Updated
  defaultSnatStatus:
    disabled: true # Updated
  # enableK8sBetaApis: # Assuming we want to remove it for update test
  #   enabledApis: []
  gatewayApiConfig:
    channel: "CHANNEL_DISABLED" # Updated
  identityServiceConfig:
    enabled: false # Updated
  maintenancePolicy: # Updated
    dailyMaintenanceWindow:
      startTime: "04:00"
      duration: "2h0m0s"
    recurringWindow:
      startTime: "2026-01-01T00:00:00Z"
      endTime: "2026-01-02T00:00:00Z"
      recurrence: "FREQ=MONTHLY;BYMONTHDAY=1"
    maintenanceExclusion:
    - exclusionName: "new-year-blackout"
      startTime: "2026-01-01T00:00:00Z"
      endTime: "2026-01-03T00:00:00Z"
      exclusionOptions:
        scope: "NO_MINOR_UPGRADES"
  meshCertificates:
    enableCertificates: false # Updated
  nodePoolAutoConfig:
    networkTags: # Updated
      tags: ["new-autopilot-tag", "another-tag"]
  nodePoolDefaults:
    nodeConfigDefaults: # Updated
      loggingVariant: "DEFAULT"
      # gcfsConfig: # Immutable
      #   enabled: false
  # podSecurityPolicyConfig: # PSP is deprecated
  #   enabled: true
  protectConfig: # Updated
    workloadConfig:
      auditMode: "DISABLED"
    workloadVulnerabilityMode: "DISABLED"
  resourceUsageExportConfig:
    bigqueryDestination: # Updated
      datasetId: "updated_gke_cluster_usage"
    enableNetworkEgressMetering: false # Updated
    enableResourceConsumptionMetering: false # Updated
  securityPostureConfig: # Updated
    mode: "DISABLED"
    vulnerabilityMode: "DISABLED"
  serviceExternalIpsConfig:
    enabled: false # Updated
  costManagementConfig:
    enabled: false # Updated
